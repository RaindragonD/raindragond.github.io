{"componentChunkName":"component---src-templates-post-item-js","path":"/distributed-system/2020-7-18-big-data-message-system/","result":{"data":{"site":{"siteMetadata":{"title":"NowhereLog"}},"markdownRemark":{"id":"322419fa-2cb7-58ff-9c9c-92afcefa629d","excerpt":"This post introduces a framework for a message system for big data built with Kafka+Flink+ElasticSearch and how do these tools work behind the scene. Components…","html":"<blockquote>\n<p>This post introduces a framework for a message system for big data built with Kafka+Flink+ElasticSearch and how do these tools work behind the scene.</p>\n</blockquote>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#components-of-a-message-system\">Components of a Message System</a></li>\n<li>\n<p><a href=\"#apache-kafka\">Apache Kafka</a></p>\n<ul>\n<li><a href=\"#kafkas-top-level-concepts\">Kafka’s Top-level Concepts</a></li>\n<li><a href=\"#kafkas-architecture\">Kafka’s Architecture</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#apache-flink\">Apache Flink</a></p>\n<ul>\n<li><a href=\"#flinks-architecture\">Flink’s Architecture</a></li>\n<li><a href=\"#flinks-dataflow-graph\">Flink’s Dataflow Graph</a></li>\n<li><a href=\"#flinks-exactly-once-guarantee\">Flink’s Exactly-Once Guarantee</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#elasticsearch\">ElasticSearch</a></p>\n<ul>\n<li><a href=\"#inverted-index\">Inverted Index</a></li>\n<li><a href=\"#elasticsearchs-top-level-concepts\">ElasticSearch’s Top-level Concepts</a></li>\n<li><a href=\"#elasticsearch-storage-structure\">ElasticSearch Storage Structure</a></li>\n<li>\n<p><a href=\"#compression-schemes\">Compression Schemes</a></p>\n<ul>\n<li><a href=\"#the-frame-of-reference\">The Frame of Reference</a></li>\n<li><a href=\"#roaring-bitmaps\">Roaring Bitmaps</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#a-java-example\">A Java Example</a></li>\n</ul>\n</div>\n<h1 id=\"components-of-a-message-system\" style=\"position:relative;\"><a href=\"#components-of-a-message-system\" aria-label=\"components of a message system permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Components of a Message System</h1>\n<p>An app today produces trillions of data that embeds enormous insights for the business executives, engineers, market analysts, etc. It is a non-trivial job to collect those data and effectively store them.</p>\n<p>Let’s think about a particular scenario and a particular type of data: <em>heartbeat</em>. Heartbeat data is a periodic signal log sent by software (or hardware) to indicate its current state. For example, for a video streaming app, when a user plays a video, the app sends multiple heartbeats that include data like the user id, the session id, the app version, the video playing status (buffering, playing, pausing), etc. These are valuable information for engineers to debug the app and for product managers/data analysts to analyze user behavior and experience. A minimal viable product is as follows: the system transfers data from the app to a database which allows easy access to individual data via a user id.</p>\n<p>For this minimal product, we still need three essential stages.</p>\n<p>First of all, we need to decide where heartbeat data should be sent from the apps on a user’s machine. Presumably, we can directly send data to a database, but this has several disadvantages. (1) We may need to process data, and this happens most efficiently on a dedicated server via batch processing. (2) We don’t want a user’s app to directly connect to our backend database or a processing server. There is an even more important reason, which introduces <strong>Apache Kafka</strong>. We may want our data sent to not a single database, but multiple different ones with distinct usage. We may also have different sources generating different data other that heartbeat data. If we allow each of the data sources and targets to connect directly, we simply get a mass. Instead, data sources send data to a Kafka server, and other servers can contact the Kafka server for a particular type of data. The data sources are called <em>producers</em>, and the latter is called <em>consumers</em>.</p>\n<p>As I mentioned, we may also want a server to process streaming data. This server is special in that we are facing millions of data per second, and we need a special processing paradigm to boost performance. This cannot be done by a normal single computer, but by a cluster of computers working in parallel. <strong>Apache Flink</strong> is a widely used streaming processing framework.</p>\n<p>Finally, we need some type of database that provides fast access to particular heartbeat data. For this post, we will use <strong>ElasticSearch</strong>, which is commonly used as a search engine, and we will talk about how it works more in-depth.</p>\n<h1 id=\"apache-kafka\" style=\"position:relative;\"><a href=\"#apache-kafka\" aria-label=\"apache kafka permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Apache Kafka</h1>\n<p>The telephone needs a switching center to accept incoming calls and match them to callees. The Internet needs switches to accept incoming packages and send them the target receivers. In the world of big data, Kafka is the switching system. Kafka accepts data stream from multiple <strong>producers</strong> such as mobile apps, web pages, network-connected hardware, and allows multiple <strong>consumers</strong> to retrieve the data.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6acae7a5ce729ea936f9bc92b9f2cc90/ab7eb/kafka1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.10810810810811%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAdqbaUMH/8QAGRABAQEAAwAAAAAAAAAAAAAAAQARAhIi/9oACAEBAAEFAvTGxdDXgLf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAbEAACAgMBAAAAAAAAAAAAAAAAEQFBEBIhIv/aAAgBAQAGPwKtTxEK2dHY5x//xAAbEAACAwADAAAAAAAAAAAAAAABEQAhMUFhgf/aAAgBAQABPyE0BMFvZgWHJcZY8jRuncFmMZcAQn//2gAMAwEAAgADAAAAEGsP/8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQMBAT8Qh//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAECAQE/EKf/xAAdEAEAAgICAwAAAAAAAAAAAAABABEhQTGBYZGx/9oACAEBAAE/ELNzUbTzhudfkcMY6je7e2Is5otq9dwHlpI+Q6if/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Kafka1\"\n        title=\"Kafka1\"\n        src=\"/static/6acae7a5ce729ea936f9bc92b9f2cc90/1c72d/kafka1.jpg\"\n        srcset=\"/static/6acae7a5ce729ea936f9bc92b9f2cc90/a80bd/kafka1.jpg 148w,\n/static/6acae7a5ce729ea936f9bc92b9f2cc90/1c91a/kafka1.jpg 295w,\n/static/6acae7a5ce729ea936f9bc92b9f2cc90/1c72d/kafka1.jpg 590w,\n/static/6acae7a5ce729ea936f9bc92b9f2cc90/a8a14/kafka1.jpg 885w,\n/static/6acae7a5ce729ea936f9bc92b9f2cc90/fbd2c/kafka1.jpg 1180w,\n/static/6acae7a5ce729ea936f9bc92b9f2cc90/ab7eb/kafka1.jpg 1860w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<em>Figure 1. Kafka. (Image source: <a href=\"https://medium.com/@stephane.maarek/the-kafka-api-battle-producer-vs-consumer-vs-kafka-connect-vs-kafka-streams-vs-ksql-ef584274c1e\">Stéphane Maarek blog</a>)</em></p>\n<h2 id=\"kafkas-top-level-concepts\" style=\"position:relative;\"><a href=\"#kafkas-top-level-concepts\" aria-label=\"kafkas top level concepts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Kafka’s Top-level Concepts</h2>\n<p>On the top abstraction level, consumers and producers interact with a Kafka server with the following essential interfaces.</p>\n<ul>\n<li>\n<p>Topic</p>\n<p>A topic is a virtual group of data. A producer sends data to a particular topic or potentially multiple topics, while a consumer subscribes to a topic to retrieve data in this virtual group. In general, a topic contains messages of the same type, but it is flexible and accepts messages of multiple types (ultimately in bytes).</p>\n</li>\n<li>\n<p>Partition</p>\n<p>The data of a topic is stored in multiple partitions, which can be thought of as an array list. A producer decides which partition a message is sent to by assigning each message a key and defining a partitioning strategy. The default partitioning strategy is hashing, and the default behavior of not having a key is round-robin.</p>\n</li>\n<li>\n<p>Offset</p>\n<p>As mentioned, a partition is like an array list, and an offset indicates an index to the list.</p>\n</li>\n<li>\n<p>Consumer Group</p>\n<p>The consumers of a topic can be further divided into consumer groups. For example, the security engineering team wants log events from Kafka for security checks, and data engineers team wants the data same for data analysis. They may require different consumption rates and processing strategies of the data, and we will have two groups. Each partition of a topic will be subscribed by at most one consumer in a group at a time. If there are more partitions in a topic than the consumers in a group, each consumer can subscribe to more than one partition. The programmer can set the system to consumers from <em>groupOffsets</em> so that the group acts as a single consumer and process data sequentially.</p>\n</li>\n</ul>\n<h2 id=\"kafkas-architecture\" style=\"position:relative;\"><a href=\"#kafkas-architecture\" aria-label=\"kafkas architecture permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Kafka’s Architecture</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/85524634813347b165ad8ced372a242a/9485f/kafka2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAHYW8paDlH/xAAcEAACAAcAAAAAAAAAAAAAAAABAgADEBESITH/2gAIAQEAAQUCyhSbLtTyWKf/xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAwEBPwGn/8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8Bh//EABYQAQEBAAAAAAAAAAAAAAAAAAEAIP/aAAgBAQAGPwJnP//EABoQAQEAAgMAAAAAAAAAAAAAAAEAEBEhUdH/2gAIAQEAAT8h2Q9ROdZoLEVGD7j/2gAMAwEAAgADAAAAEIsP/8QAFhEAAwAAAAAAAAAAAAAAAAAAEBEx/9oACAEDAQE/EEg//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAERMf/aAAgBAgEBPxCroj//xAAZEAEAAwEBAAAAAAAAAAAAAAABABExIUH/2gAIAQEAAT8QKSKKFcqOnCWK5sdK1uXkeOclFjpqYZP/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Kafka2\"\n        title=\"Kafka2\"\n        src=\"/static/85524634813347b165ad8ced372a242a/1c72d/kafka2.jpg\"\n        srcset=\"/static/85524634813347b165ad8ced372a242a/a80bd/kafka2.jpg 148w,\n/static/85524634813347b165ad8ced372a242a/1c91a/kafka2.jpg 295w,\n/static/85524634813347b165ad8ced372a242a/1c72d/kafka2.jpg 590w,\n/static/85524634813347b165ad8ced372a242a/a8a14/kafka2.jpg 885w,\n/static/85524634813347b165ad8ced372a242a/fbd2c/kafka2.jpg 1180w,\n/static/85524634813347b165ad8ced372a242a/9485f/kafka2.jpg 2378w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<em>Figure 2. Kafka’s Architecture. (Image source: <a href=\"https://data-flair.training/blogs/kafka-architecture/\">Data Flair</a>)</em></p>\n<ul>\n<li>\n<p>Brokers</p>\n<p>A Kafka is a cluster of servers which comprises of many brokers that mainly serve the data and a Zookeeper cluster that stores configuration information. Each broker serves multiple partitions that not necessarily belong to the same topic.</p>\n</li>\n<li>\n<p>Zookeeper</p>\n<p>Zookeeper provides configuration maintenance service. What is the configuration? It includes information like what brokers are registered, what are the existing topics, and where are the partitions for each topic. Zookeeper is a fault-tolerant service based on Zab, a consensus algorithm similar to Raft on the high level. Here is a previous post that introduces <a href=\"https://data-flair.training/blogs/kafka-architecture/\">Raft</a>.</p>\n</li>\n<li>\n<p>Replication</p>\n<p>Each partition is replicated according to a <em>replication factor</em>. Each partition has a leader that responds to requests, and other replicas will step up if the leader fails.</p>\n</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/85b85056558b42df63f2db3e7d766d31/a77ef/kafka3.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBP/EABUBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAHfG6SKML//xAAZEAACAwEAAAAAAAAAAAAAAAAAAQIDMTL/2gAIAQEAAQUCuH1EsHsM/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQIBAT8BZ//EABYQAQEBAAAAAAAAAAAAAAAAAAEAEP/aAAgBAQAGPwInCc//xAAeEAACAQMFAAAAAAAAAAAAAAAAATERcbEhQWGRof/aAAgBAQABPyGnozI34NKdyI8TwSXP/9oADAMBAAIAAwAAABAPL//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/EGf/xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQIBAT8QWJP/xAAeEAEAAgEEAwAAAAAAAAAAAAABABFRITFhcYGhwf/aAAgBAQABPxApqoZExzNzbaDd9Q0xfJwcz1WEroog1s6uXRP/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Kafka3\"\n        title=\"Kafka3\"\n        src=\"/static/85b85056558b42df63f2db3e7d766d31/1c72d/kafka3.jpg\"\n        srcset=\"/static/85b85056558b42df63f2db3e7d766d31/a80bd/kafka3.jpg 148w,\n/static/85b85056558b42df63f2db3e7d766d31/1c91a/kafka3.jpg 295w,\n/static/85b85056558b42df63f2db3e7d766d31/1c72d/kafka3.jpg 590w,\n/static/85b85056558b42df63f2db3e7d766d31/a77ef/kafka3.jpg 706w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<em>Figure 3. Kafka’s Replication. (Image source: <a href=\"https://jack-vanlightly.com/blog/2018/9/2/rabbitmq-vs-kafka-part-6-fault-tolerance-and-high-availability-with-kafka\">Jack Vanlightly blog</a>)</em></p>\n<h1 id=\"apache-flink\" style=\"position:relative;\"><a href=\"#apache-flink\" aria-label=\"apache flink permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Apache Flink</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1ad6ea63545d472d41a29dc86ee3e07b/d165a/flink1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.108108108108105%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdmIWg//xAAYEAADAQEAAAAAAAAAAAAAAAAAAhIRIf/aAAgBAQABBQJqFren/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFhABAQEAAAAAAAAAAAAAAAAAIQAQ/9oACAEBAAY/Aic//8QAGBABAQADAAAAAAAAAAAAAAAAASEAEFH/2gAIAQEAAT8hki5oCbn/2gAMAwEAAgADAAAAEHPP/8QAFREBAQAAAAAAAAAAAAAAAAAAEGH/2gAIAQMBAT8Qp//EABYRAQEBAAAAAAAAAAAAAAAAABEBEP/aAAgBAgEBPxAYZ//EABoQAQACAwEAAAAAAAAAAAAAAAEAESExQdH/2gAIAQEAAT8QCpaOya7yNC5teeQkYLWcz//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Flink1\"\n        title=\"Flink1\"\n        src=\"/static/1ad6ea63545d472d41a29dc86ee3e07b/1c72d/flink1.jpg\"\n        srcset=\"/static/1ad6ea63545d472d41a29dc86ee3e07b/a80bd/flink1.jpg 148w,\n/static/1ad6ea63545d472d41a29dc86ee3e07b/1c91a/flink1.jpg 295w,\n/static/1ad6ea63545d472d41a29dc86ee3e07b/1c72d/flink1.jpg 590w,\n/static/1ad6ea63545d472d41a29dc86ee3e07b/a8a14/flink1.jpg 885w,\n/static/1ad6ea63545d472d41a29dc86ee3e07b/fbd2c/flink1.jpg 1180w,\n/static/1ad6ea63545d472d41a29dc86ee3e07b/d165a/flink1.jpg 1400w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<em>Figure 4. Flink. (Image source: <a href=\"https://flink.apache.org\">Apache Flink</a>)</em></p>\n<p>Besides a switch that manages data flow, we also need a tool that can process the data stream quickly. How quickly? At least as fast as the data production rate. This demand introduces us to Flink which supports the essential <a href=\"https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/operators/\">data stream transformations</a> such as map, filter, reduce, aggregation, and many more.</p>\n<h2 id=\"flinks-architecture\" style=\"position:relative;\"><a href=\"#flinks-architecture\" aria-label=\"flinks architecture permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Flink’s Architecture</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/09ac54b66b0a455abce31750fe354dad/d976b/flink3.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAgX/xAAUAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHtz0LFhsT/xAAaEAACAwEBAAAAAAAAAAAAAAABAgAREiEy/9oACAEBAAEFAibXuE85qEtup//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAECAQE/AWf/xAAaEAACAgMAAAAAAAAAAAAAAAAAARARITFh/9oACAEBAAY/AnRpmY5H/8QAGRABAQEBAQEAAAAAAAAAAAAAAREAIWFR/9oACAEBAAE/ISK6+YLHS6zlH3FOOACnWj5v/9oADAMBAAIAAwAAABCkD//EABcRAQEBAQAAAAAAAAAAAAAAAAEAIVH/2gAIAQMBAT8QHk7f/8QAFxEBAQEBAAAAAAAAAAAAAAAAAQARMf/aAAgBAgEBPxAHUgy//8QAGxABAAMAAwEAAAAAAAAAAAAAAQARITFRgUH/2gAIAQEAAT8QIAYlLR6lvkhQrsIBLHFs3K+yuXthnSgcM9gPx7P/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Flink2\"\n        title=\"Flink2\"\n        src=\"/static/09ac54b66b0a455abce31750fe354dad/1c72d/flink3.jpg\"\n        srcset=\"/static/09ac54b66b0a455abce31750fe354dad/a80bd/flink3.jpg 148w,\n/static/09ac54b66b0a455abce31750fe354dad/1c91a/flink3.jpg 295w,\n/static/09ac54b66b0a455abce31750fe354dad/1c72d/flink3.jpg 590w,\n/static/09ac54b66b0a455abce31750fe354dad/a8a14/flink3.jpg 885w,\n/static/09ac54b66b0a455abce31750fe354dad/fbd2c/flink3.jpg 1180w,\n/static/09ac54b66b0a455abce31750fe354dad/d976b/flink3.jpg 2614w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<em>Figure 5. Flink’s Architecture. (Image source: <a href=\"http://wuchong.me/blog/2016/05/03/flink-internals-overview/\">Jark’s Blog</a>)</em></p>\n<p>A Flink cluster has a JobManager and multiple TaskManagers.</p>\n<ul>\n<li>Flink Program: The Flink program generates a data-flow diagram, a DAG (directed acyclic graph), based on the program code, and submit the job to the JobManager.</li>\n<li>JobManager: The JobManager further optimizes the data-flow diagram and splits the job into several tasks. It manages the TaskManagers to complete the tasks.</li>\n<li>TaskManager: Each TaskManager has several pre-set slots for tasks. Each Task is an independent thread.</li>\n</ul>\n<h2 id=\"flinks-dataflow-graph\" style=\"position:relative;\"><a href=\"#flinks-dataflow-graph\" aria-label=\"flinks dataflow graph permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Flink’s Dataflow Graph</h2>\n<ul>\n<li>Stream Graph: generated based on the initial program code.</li>\n<li>Job Graph: optimized by the Flink Program and submitted to the JobManager.</li>\n<li>Execution Graph: optimized by the JobManager for the actual execution.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e16a9f1f1cac372d211e3f5ba273b3dd/f060d/flink4.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.27027027027026%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAECAwX/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAB7iUy6Fif/8QAGBAAAgMAAAAAAAAAAAAAAAAAEUEAARD/2gAIAQEAAQUCSGCxP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABYRAQEBAAAAAAAAAAAAAAAAAAABEf/aAAgBAgEBPwFkf//EABUQAQEAAAAAAAAAAAAAAAAAACBB/9oACAEBAAY/Aqv/xAAfEAACAQIHAAAAAAAAAAAAAAAAASExQRARYXGBkaH/2gAIAQEAAT8hWgX14qb32JPJzYkT7h//2gAMAwEAAgADAAAAEKPf/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAERQf/aAAgBAwEBPxDVy//EABgRAAIDAAAAAAAAAAAAAAAAAAABMWGB/9oACAECAQE/EHGFB//EAB4QAAICAgIDAAAAAAAAAAAAAAERADEhQWFxEFGh/9oACAEBAAE/ENKE7vcKIEaCXRfMIkknNDdm+nuU6MD4HHj/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Flink3\"\n        title=\"Flink3\"\n        src=\"/static/e16a9f1f1cac372d211e3f5ba273b3dd/1c72d/flink4.jpg\"\n        srcset=\"/static/e16a9f1f1cac372d211e3f5ba273b3dd/a80bd/flink4.jpg 148w,\n/static/e16a9f1f1cac372d211e3f5ba273b3dd/1c91a/flink4.jpg 295w,\n/static/e16a9f1f1cac372d211e3f5ba273b3dd/1c72d/flink4.jpg 590w,\n/static/e16a9f1f1cac372d211e3f5ba273b3dd/a8a14/flink4.jpg 885w,\n/static/e16a9f1f1cac372d211e3f5ba273b3dd/fbd2c/flink4.jpg 1180w,\n/static/e16a9f1f1cac372d211e3f5ba273b3dd/f060d/flink4.jpg 2594w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<em>Figure 6. Flink’s Data Flow Diagram. (Image source: <a href=\"http://wuchong.me/blog/2016/05/03/flink-internals-overview/\">Jark’s Blog</a>)</em></p>\n<h2 id=\"flinks-exactly-once-guarantee\" style=\"position:relative;\"><a href=\"#flinks-exactly-once-guarantee\" aria-label=\"flinks exactly once guarantee permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Flink’s Exactly-Once Guarantee</h2>\n<p>The system fails sometimes so that some messages are processed but not sent out. There are three strategies to deal  with this issue:</p>\n<ul>\n<li>At-most-once: Each message is processed at most once, which means messages may be lost.</li>\n<li>At-least-once: Each message is processed at least once, which means messages may be duplicated.</li>\n<li>Exactly-once: Each message is processed exactly once.</li>\n</ul>\n<p>The exactly-once grantee is the most desirable but also the hardest and most expensive. For at-most-once, it can be done in a fire-and-forgot fashion without extra implementations. For at-least-once, we need to have an acknowledgment mechanism. For the exactly-once, we need to further avoid duplicates.</p>\n<p>Flink manages to achieve the exactly-once guarantee by the Checkpoint mechanism and the barrier aligning mechanism. In short, the data stream is divided into blocks by some barriers. At each operator, data will be kept into a buffer until the block is aligned, i.e. when the whole block has arrived. Then the block will be snapshotted and check-pointed before sending it to the next operator.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dc189b6639ba83e377017b4252ac3436/b4e32/flink2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.05405405405406%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMCBf/EABUBAQEAAAAAAAAAAAAAAAAAAAEA/9oADAMBAAIQAxAAAAHrVnsQj//EABkQAAMBAQEAAAAAAAAAAAAAAAECEgMRAP/aAAgBAQABBQLQOQwPEDBNL81cS4//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAfEAABAwMFAAAAAAAAAAAAAAAAARESAiEiIzEyUaH/2gAIAQEABj8CwqiW37EktzT9MeQkmc//xAAaEAADAQEBAQAAAAAAAAAAAAAAAREhUUGR/9oACAEBAAE/IUiDXX0ce5IWFfTRisW7Rt4Zw+xT/9oADAMBAAIAAwAAABA4/wD/xAAXEQADAQAAAAAAAAAAAAAAAAAAATFB/9oACAEDAQE/EMQ6f//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EAB0QAQACAgIDAAAAAAAAAAAAAAERIQAxQWFxkaH/2gAIAQEAAT8QPoHUKHNXgXog9D45wIJlCn3jBwI6RHWQVoKTU+5ywVGl/c//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Flink4\"\n        title=\"Flink4\"\n        src=\"/static/dc189b6639ba83e377017b4252ac3436/1c72d/flink2.jpg\"\n        srcset=\"/static/dc189b6639ba83e377017b4252ac3436/a80bd/flink2.jpg 148w,\n/static/dc189b6639ba83e377017b4252ac3436/1c91a/flink2.jpg 295w,\n/static/dc189b6639ba83e377017b4252ac3436/1c72d/flink2.jpg 590w,\n/static/dc189b6639ba83e377017b4252ac3436/b4e32/flink2.jpg 628w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><em>Figure 7. Flink’s Checkpoint Mechanism for Exactly-Once. (Image source: <a href=\"https://zhuanlan.zhihu.com/p/20585530\">Chengxiang Li at Zhihu</a>)</em></p>\n<h1 id=\"elasticsearch\" style=\"position:relative;\"><a href=\"#elasticsearch\" aria-label=\"elasticsearch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ElasticSearch</h1>\n<p>Finally, we need to store our data in some database. ElasticSearch is suitable for a search engine application. It allows fast queries to records that include a specific field. For example, we can search for messages that have the phrase “big data”. It provides RESTful API which allows convenient integration into a system.</p>\n<h2 id=\"inverted-index\" style=\"position:relative;\"><a href=\"#inverted-index\" aria-label=\"inverted index permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Inverted Index</h2>\n<p>An inverted index is an essential idea that allows ElasticSearch to provide search-engine performance. Suppose we have a lot of documents, each having a unique ID. The “non-inverted” index is a mapping from an ID to a document. </p>\n<table>\n<thead>\n<tr>\n<th>ID</th>\n<th>document</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0</td>\n<td>hello world</td>\n</tr>\n<tr>\n<td>1</td>\n<td>hello ES</td>\n</tr>\n<tr>\n<td>2</td>\n<td>ES rules</td>\n</tr>\n</tbody>\n</table>\n<p>The inverted index is a mapping from a string (presenting in a document or multiple documents) to a list of IDs. In this way, when we query a string, the database can return a list of documents that contain the string, just like a search engine. Furthermore, notice that the strings are sorted so that we can use binary search to access the document IDs associated with a string fast. (This means insertion overhead of course.)</p>\n<table>\n<thead>\n<tr>\n<th>string</th>\n<th>IDs</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ES</td>\n<td>[1, 2]</td>\n</tr>\n<tr>\n<td>hello</td>\n<td>[0, 1]</td>\n</tr>\n<tr>\n<td>rules</td>\n<td>[2]</td>\n</tr>\n<tr>\n<td>world</td>\n<td>[0]</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"elasticsearchs-top-level-concepts\" style=\"position:relative;\"><a href=\"#elasticsearchs-top-level-concepts\" aria-label=\"elasticsearchs top level concepts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ElasticSearch’s Top-level Concepts</h2>\n<ul>\n<li>index\nAn index in ElasticSearch can be understood as a table in a MySQL database, but of course, the storage structures are very different. We need to specify an index when writing and reading data. We can have an alias to indices to read from multiple indices at once (like searching a query in multiple indices).</li>\n<li>\n<p>mapping\nA mapping is a JSON string that defines the data structure of the documents stored in an index. That being said, the data type is flexible, and there will not be errors if a document does not comply with the mapping. The mapping may seem quite useless in this sense, but it has another more important use: it defines which field will be inverted indexed. Furthermore, for strings, we can define an analyzer to delimit a string, which includes tokenizer and filter which can, for example, filter out stop words. A sample mapping for an index called <em>my-index</em> with 4 fields (“age”, “email”, “employee id”, and “name”) is as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"my-index\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"mappings\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"properties\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"age\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"integer\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"email\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"keyword\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"employee-id\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"keyword\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"index\"</span> <span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"name\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"text\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Both “keyword” and “text” types are strings, but the “keyword” type is treated atomically, while the “text” type can set the analyzer to further be delimited. When “index” is set to false, the field will not be inverted indexed.</p>\n<p>Checkout the <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html\">documentation</a> for more details.</p>\n</li>\n</ul>\n<h2 id=\"elasticsearch-storage-structure\" style=\"position:relative;\"><a href=\"#elasticsearch-storage-structure\" aria-label=\"elasticsearch storage structure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ElasticSearch Storage Structure</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a7150aa97ddde8bfdde9c138a5032ed7/32840/es1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAe0uQ0C//8QAGBABAQADAAAAAAAAAAAAAAAAAAECMUL/2gAIAQEAAQUCyrpYm3//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAXEAEAAwAAAAAAAAAAAAAAAAAQABFB/9oACAEBAAY/ApjZ/8QAGxAAAgIDAQAAAAAAAAAAAAAAASEAERAxUZH/2gAIAQEAAT8hpG/Y1unIIIhiACh4/9oADAMBAAIAAwAAABCID//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/EIf/xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPxCH/8QAGxABAAMBAQEBAAAAAAAAAAAAAQARITFBYXH/2gAIAQEAAT8QQEBu8D8FyHsqF5szZx+MugPx5LeAvTsMKJ//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ES1\"\n        title=\"ES1\"\n        src=\"/static/a7150aa97ddde8bfdde9c138a5032ed7/1c72d/es1.jpg\"\n        srcset=\"/static/a7150aa97ddde8bfdde9c138a5032ed7/a80bd/es1.jpg 148w,\n/static/a7150aa97ddde8bfdde9c138a5032ed7/1c91a/es1.jpg 295w,\n/static/a7150aa97ddde8bfdde9c138a5032ed7/1c72d/es1.jpg 590w,\n/static/a7150aa97ddde8bfdde9c138a5032ed7/a8a14/es1.jpg 885w,\n/static/a7150aa97ddde8bfdde9c138a5032ed7/fbd2c/es1.jpg 1180w,\n/static/a7150aa97ddde8bfdde9c138a5032ed7/32840/es1.jpg 1938w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<em>Figure 8. ElasticSearch’s Storage Structure. (Image source: Found)</em></p>\n<ul>\n<li>ElasticSearch Cluster: The cluster is represented by the cloud, which consists of several nodes.</li>\n<li>Node: Each node is a server represented by a black box.</li>\n<li>Shard: A shard is a data unit, represented by the green box in the graph. Each index is divided into a preset number of shards. Each node contains several shards. This storage scheme is very similar to Kafka, for which an index is comparable to a Kafka’s topic and a shard is comparable to a Kafka’s partition.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f61f9958febf73f20787c10c94dc6849/f025f/es2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQCAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHciJjxWH//xAAZEAACAwEAAAAAAAAAAAAAAAABAwACESH/2gAIAQEAAQUCseZKxnFlpiTtf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABoQAQABBQAAAAAAAAAAAAAAAAABESEyQWH/2gAIAQEABj8ClkulpXr/xAAaEAEAAwADAAAAAAAAAAAAAAABABFRMXGh/9oACAEBAAE/IWKr7l9+RqIrRqOzkxwjrlj/2gAMAwEAAgADAAAAEDPP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHRABAAMAAQUAAAAAAAAAAAAAAQARMdFBUWFxkf/aAAgBAQABPxCggQoFQS9fJwllA7VVnSODoE+k9nezzNR0tZhP/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ES2\"\n        title=\"ES2\"\n        src=\"/static/f61f9958febf73f20787c10c94dc6849/1c72d/es2.jpg\"\n        srcset=\"/static/f61f9958febf73f20787c10c94dc6849/a80bd/es2.jpg 148w,\n/static/f61f9958febf73f20787c10c94dc6849/1c91a/es2.jpg 295w,\n/static/f61f9958febf73f20787c10c94dc6849/1c72d/es2.jpg 590w,\n/static/f61f9958febf73f20787c10c94dc6849/a8a14/es2.jpg 885w,\n/static/f61f9958febf73f20787c10c94dc6849/fbd2c/es2.jpg 1180w,\n/static/f61f9958febf73f20787c10c94dc6849/f025f/es2.jpg 1676w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<em>Figure 9. Lucene Index. (Image source: Found)</em></p>\n<p>What’s inside a shard? ElasticSearch is based on another Apache software—<a href=\"https://lucene.apache.org/core/\">Lucene index</a>, which essentially implements the inverted index. The most relevant structure inside a shard is the Lucene index. A Lucene index is further divided into segments, and in each segment, we have our familiar inverted index.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 574px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cfec4292c2e5537eecc1b1847ab04018/b5079/es3.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.72972972972974%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAQFAf/EABYBAQEBAAAAAAAAAAAAAAAAAAIAAf/aAAwDAQACEAMQAAABrp0tRUHDL//EABoQAAICAwAAAAAAAAAAAAAAAAECAxAREkH/2gAIAQEAAQUClJCM7bRMSvMV/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oACAEDAQE/AbGP/8QAFhEAAwAAAAAAAAAAAAAAAAAAAAER/9oACAECAQE/AU4U/8QAGBAAAgMAAAAAAAAAAAAAAAAAAAEgMTL/2gAIAQEABj8CZouH/8QAGxABAQACAwEAAAAAAAAAAAAAAQARUSFhkbH/2gAIAQEAAT8hRBx3CQL2QKnmfqw0WDV//9oADAMBAAIAAwAAABAIP//EABcRAQEBAQAAAAAAAAAAAAAAAAEAETH/2gAIAQMBAT8QV4wgy//EABcRAQEBAQAAAAAAAAAAAAAAAAEAETH/2gAIAQIBAT8QPokLuX//xAAdEAEAAgICAwAAAAAAAAAAAAABABFBcSFhMVGR/9oACAEBAAE/EEmMSg1mDJhjSPzLlr0T389ty1b+UC8A0T//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ES3\"\n        title=\"ES3\"\n        src=\"/static/cfec4292c2e5537eecc1b1847ab04018/b5079/es3.jpg\"\n        srcset=\"/static/cfec4292c2e5537eecc1b1847ab04018/a80bd/es3.jpg 148w,\n/static/cfec4292c2e5537eecc1b1847ab04018/1c91a/es3.jpg 295w,\n/static/cfec4292c2e5537eecc1b1847ab04018/b5079/es3.jpg 574w\"\n        sizes=\"(max-width: 574px) 100vw, 574px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><em>Figure 10. Inverted Index in ElasticSearch. (Image source: Found)</em></p>\n<p>But wait, what is that tree structure on the left? The problem arises when we have too many keys for the inverted index. If you think about it, the number of keys grows much faster than the number of documents. Therefore, we won’t be able to store the entire dictionary in RAM. Even though the binary search is fast, I/O with disks is slow. To facilitate this process, we store the tree structure to point to the exact offset corresponding to a prefix.</p>\n<p>The tree structure is officially known as the Finite-State Transducer. If you know about the B+ tree, they have the same high-level idea. Or if you know about the Trie, you should understand how such an implementation can facilitate our queries.</p>\n<h2 id=\"compression-schemes\" style=\"position:relative;\"><a href=\"#compression-schemes\" aria-label=\"compression schemes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compression Schemes</h2>\n<p>The final bit of information, which I think is quite interesting, is two compression schemes used by ElasticSearch. In a search engine setting, the key of an inverted index can point to millions or even billions of document IDs. We, therefore, need some compression scheme to scale down the size. Note that we assume the list is <strong>sorted</strong>.</p>\n<h3 id=\"the-frame-of-reference\" style=\"position:relative;\"><a href=\"#the-frame-of-reference\" aria-label=\"the frame of reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Frame of Reference</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c8b2ea826848cd7bbbc9263e9388902d/3e5d7/es4.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.72972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAEDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHanWdjGH//xAAYEAEBAQEBAAAAAAAAAAAAAAAAARESAv/aAAgBAQABBQK1tbXqOXL/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAbEAACAgMBAAAAAAAAAAAAAAAAARFBITFhwf/aAAgBAQABPyF9F3h2HuIJawJz/9oADAMBAAIAAwAAABCAD//EABcRAQADAAAAAAAAAAAAAAAAAAABESH/2gAIAQMBAT8Qm2v/xAAWEQEBAQAAAAAAAAAAAAAAAAABACH/2gAIAQIBAT8QEsv/xAAbEAEBAQEBAAMAAAAAAAAAAAABESEAMVFh8P/aAAgBAQABPxAwWDXxvb6b+fPEy76GVK29iX603imob99//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ES3\"\n        title=\"ES3\"\n        src=\"/static/c8b2ea826848cd7bbbc9263e9388902d/1c72d/es4.jpg\"\n        srcset=\"/static/c8b2ea826848cd7bbbc9263e9388902d/a80bd/es4.jpg 148w,\n/static/c8b2ea826848cd7bbbc9263e9388902d/1c91a/es4.jpg 295w,\n/static/c8b2ea826848cd7bbbc9263e9388902d/1c72d/es4.jpg 590w,\n/static/c8b2ea826848cd7bbbc9263e9388902d/a8a14/es4.jpg 885w,\n/static/c8b2ea826848cd7bbbc9263e9388902d/3e5d7/es4.jpg 1126w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<em>Figure 11. The Frame of Reference Compression Scheme. (Image source: N/A)</em></p>\n<ol>\n<li>delta-encode: with the first value unchanged, every value except the first is substituted by the difference between itself and the previous element.</li>\n<li>split into blocks: each block contains a fixed number of values</li>\n<li>bit packing: the first byte of every block signifies how many bytes each value uses in the block, and the number of bytes is determined by the largest value in the block</li>\n</ol>\n<h3 id=\"roaring-bitmaps\" style=\"position:relative;\"><a href=\"#roaring-bitmaps\" aria-label=\"roaring bitmaps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Roaring Bitmaps</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3ae63e1f81935e46b1dadc460ee0cb24/3bf57/es5.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.972972972972975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMCBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB2IWVIDg//8QAFxABAQEBAAAAAAAAAAAAAAAAAQAgIf/aAAgBAQABBQJbsY//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAaEAADAQADAAAAAAAAAAAAAAAAAREhEDFB/9oACAEBAAE/IXRaOPWXNo0p1wj/2gAMAwEAAgADAAAAEF8//8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQMBAT8QiP/EABYRAQEBAAAAAAAAAAAAAAAAAAABEf/aAAgBAgEBPxCVr//EABoQAQACAwEAAAAAAAAAAAAAAAEAESFBkdH/2gAIAQEAAT8QbS13T5E2erGUKw7YDAcgFwAYJ//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ES5\"\n        title=\"ES5\"\n        src=\"/static/3ae63e1f81935e46b1dadc460ee0cb24/1c72d/es5.jpg\"\n        srcset=\"/static/3ae63e1f81935e46b1dadc460ee0cb24/a80bd/es5.jpg 148w,\n/static/3ae63e1f81935e46b1dadc460ee0cb24/1c91a/es5.jpg 295w,\n/static/3ae63e1f81935e46b1dadc460ee0cb24/1c72d/es5.jpg 590w,\n/static/3ae63e1f81935e46b1dadc460ee0cb24/a8a14/es5.jpg 885w,\n/static/3ae63e1f81935e46b1dadc460ee0cb24/fbd2c/es5.jpg 1180w,\n/static/3ae63e1f81935e46b1dadc460ee0cb24/3bf57/es5.jpg 1302w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<em>Figure 12. Roaring Bitmaps. (Image source: N/A)</em></p>\n<ol>\n<li>modulus encode: each value <em>v</em> is encoded into <em>(v/N, v%N)</em>, where N is 65536 in the example.</li>\n<li>split into blocks: the encoded values are grouped by <em>v/N</em></li>\n</ol>\n<h1 id=\"a-java-example\" style=\"position:relative;\"><a href=\"#a-java-example\" aria-label=\"a java example permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A Java Example</h1>\n<p>Here is a simple Java example that uses Flink to read from a Kafka server and writes to an ElasticSearch server. Note that you need to start <a href=\"https://kafka.apache.org/quickstart\">a Kafka server, a Kafka producer</a>, and <a href=\"https://logz.io/blog/elasticsearch-tutorial/\">an ElasticSearch server</a> first.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Kafka2ES</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">StreamExecutionEnvironment</span> env <span class=\"token operator\">=</span> <span class=\"token class-name\">StreamExecutionEnvironment</span><span class=\"token punctuation\">.</span><span class=\"token function\">getExecutionEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">DataStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> stream <span class=\"token operator\">=</span> <span class=\"token function\">readFromKafka</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">writeToElastic</span><span class=\"token punctuation\">(</span>stream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// execute program</span>\n        env<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Test Flink!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">DataStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">readFromKafka</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StreamExecutionEnvironment</span> env<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Properties</span> properties <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Properties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// connect to a Kafka server at localhost</span>\n        properties<span class=\"token punctuation\">.</span><span class=\"token function\">setProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bootstrap.servers\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"localhost:9092\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// consumer group = \"test-group\"</span>\n        properties<span class=\"token punctuation\">.</span><span class=\"token function\">setProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"group.id\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test-group\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// create a data stream by consuming Kafka's topic = \"test-topic\"</span>\n        <span class=\"token class-name\">FlinkKafkaConsumer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> flinkKafkaConsumer <span class=\"token operator\">=</span>\n                <span class=\"token keyword\">new</span> <span class=\"token class-name\">FlinkKafkaConsumer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test-topuc\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SimpleStringSchema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// set offset to the earlist</span>\n        flinkKafkaConsumer<span class=\"token punctuation\">.</span><span class=\"token function\">setStartFromEarliest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// sink data stream to ElasticSearch</span>\n        <span class=\"token class-name\">DataStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> stream <span class=\"token operator\">=</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">addSource</span><span class=\"token punctuation\">(</span>flinkKafkaConsumer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> stream<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">writeToElastic</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DataStream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> stream<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HttpHost</span><span class=\"token punctuation\">></span></span> httpHosts <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        httpHosts<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpHost</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9200</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"http\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// create a esSinkBuilder that directly sends each message from the data stream to ES's index = \"test-es\"</span>\n        <span class=\"token class-name\">ElasticsearchSink</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Builder</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> esSinkBuilder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ElasticsearchSink</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Builder</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>\n                httpHosts<span class=\"token punctuation\">,</span>\n                <span class=\"token keyword\">new</span> <span class=\"token class-name\">ElasticsearchSinkFunction</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">private</span> <span class=\"token class-name\">IndexRequest</span> <span class=\"token function\">createIndexRequest</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> element<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> esJson <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        esJson<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Requests</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">indexRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test-es\"</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">source</span><span class=\"token punctuation\">(</span>esJson<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n\n                    <span class=\"token annotation punctuation\">@Override</span>\n                    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> s<span class=\"token punctuation\">,</span> <span class=\"token class-name\">RuntimeContext</span> runtimeContext<span class=\"token punctuation\">,</span> <span class=\"token class-name\">RequestIndexer</span> requestIndexer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        requestIndexer<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token function\">createIndexRequest</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// configuration for the bulk requests; this instructs the sink to emit after every element, otherwise they would be buffered</span>\n        esSinkBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">setBulkFlushMaxActions</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        stream<span class=\"token punctuation\">.</span><span class=\"token function\">addSink</span><span class=\"token punctuation\">(</span>esSinkBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"Big Data Message System","date":"July 18, 2020","description":"This post introduces a framework for a message system for big data built with Kafka+Flink+ElasticSearch and how do these tools work behind the scene."}}},"pageContext":{"slug":"/distributed-system/2020-7-18-big-data-message-system/","previous":{"fields":{"collection":"distributed-system","slug":"/distributed-system/2020-7-16-distributed-system-raft/"},"frontmatter":{"title":"A Fault-Tolerant Distributed System with Raft"}},"next":null}},"staticQueryHashes":["3589320610","3966865564"]}